---
- name: check kubeadm
  stat:
    path: /etc/kubernetes/pki/ca.crt
  register: kubeadm_check

- name: kubeadm init
  command: kubeadm init --pod-network-cidr 10.1.0.0/16
  when: not kubeadm_check.stat.exists

- name: k8s dir
  file:
    path: /home/{{ ansible_user }}/.kube
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0755

- name: k8s conf
  copy:
    src: /etc/kubernetes/admin.conf
    remote_src: yes
    dest: /home/{{ ansible_user }}/.kube/config
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0755

- name: deploy networking & ingress controller
  command: kubectl apply -f "{{ item.url }}"
  with_items:
    - name: networking
      url: https://projectcalico.docs.tigera.io/manifests/canal.yaml
    - name: ingress controller
      url: https://raw.githubusercontent.com/haproxytech/kubernetes-ingress/master/deploy/haproxy-ingress.yaml
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
    

- name: get ingress controller service
  k8s_info:
    kind: service
    namespace: haproxy-controller
  register: ingress_controller

- name: save ingress controller service
  debug: 
    var: ingress_controller

- name: check join command
  delegate_to: localhost
  stat:
    path: "{{ join_tmp_path }}"
  register: join_check

- name: get join
  command: kubeadm token create --print-join-command
  when: not join_check.stat.exists
  register: join_command

- name: copy join
  delegate_to: localhost
  copy:
    content: "{{ join_command.stdout }}"
    dest: "{{ join_tmp_path }}"